#!/usr/bin/env node
"use strict";var Sr=Object.create;var fe=Object.defineProperty;var vr=Object.getOwnPropertyDescriptor;var Er=Object.getOwnPropertyNames;var Or=Object.getPrototypeOf,Rr=Object.prototype.hasOwnProperty;var _r=(r,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Er(e))!Rr.call(r,a)&&a!==t&&fe(r,a,{get:()=>e[a],enumerable:!(o=vr(e,a))||o.enumerable});return r};var E=(r,e,t)=>(t=r!=null?Sr(Or(r)):{},_r(e||!r||!r.__esModule?fe(t,"default",{value:r,enumerable:!0}):t,r));function Br(r){let e=r.split("."),t=[];t.push({name:"%",domain:r});for(let o=1;o<e.length-1;o++){let a=e.slice(o).join(".");t.push({name:"%",domain:a})}return t}function ee(r){if(!r.includes("://"))try{return ee(`https://${r}`)}catch{return[{name:"%",domain:r}]}try{let e=new URL(r);return Br(e.hostname)}catch{return[{name:"%",domain:r}]}}var pe=E(require("minimist"),1);function le(r){let e=(0,pe.default)(r,{string:["browser","profile","url","domain","name","output","store"],boolean:["help","version","verbose","dump","dump-grouped","render","render-grouped"],alias:{b:"browser",p:"profile",u:"url",d:"domain",n:"name",h:"help",v:"version",D:"dump-grouped",r:"render",R:"render-grouped"}}),{_:t,...o}=e;return{values:o,positionals:t}}var de=require("consola");var ue=require("os"),me=require("dotenv"),A=require("zod");(0,me.config)();var Pr=A.z.object({LOG_LEVEL:A.z.enum(["debug","info","warn","error"]).default("info"),HOME:A.z.string().optional().transform(r=>r??process.env.USERPROFILE??"").pipe(A.z.string().min(1))}),re=Pr.parse({LOG_LEVEL:process.env.LOG_LEVEL,HOME:(0,ue.homedir)()});var Ir=(0,de.createConsola)({fancy:!0,formatOptions:{showLogLevel:!1,colors:!0,date:!1,compact:!0,columns:typeof process.stdout.columns=="number"?process.stdout.columns:80},level:re.LOG_LEVEL==="debug"?5:2}),ko=re.LOG_LEVEL==="debug",Lr=Ir,l=Lr;function ce(r,e,t){e?l.success(`${r} succeeded`,t):l.error(`${r} failed`,t)}function c(r,e,t){let o=e instanceof Error?e.message:String(e);l.error(r,{...t,error:o})}function x(r,e,t){l.warn(`[${r}] ${e}`,t)}function d(r){return l.withTag(r)}var U=class{constructor(e){this.strategy=e}async queryCookies(e,t){return this.strategy.queryCookies(e.name,e.domain,t?.store)}};var ye=require("fs"),q=require("path"),Ce=E(require("fast-glob"),1);var ge=require("os"),xe=require("path"),O=(()=>{let r=(0,ge.homedir)();if(!r)throw new Error("Unable to determine user home directory");return(0,xe.join)(r,"Library","Application Support","Google","Chrome")})();var he=E(require("better-sqlite3"),1);function Tr(r){try{return new he.default(r,{readonly:!0,fileMustExist:!0})}catch(e){throw c("Database open failed",e,{file:r}),e}}function Fr(r){try{return r.close(),Promise.resolve()}catch(e){return c("Database close failed",e),Promise.reject(e instanceof Error?e:new Error("Failed to close database: Unknown error"))}}async function Q({file:r,sql:e,params:t,rowFilter:o,rowTransform:a}){let s;try{s=Tr(r);let p=s.prepare(e).all(t),f=o?p.filter(o):p;return a?f.map(a):f}catch(i){throw c("Database query failed",i,{file:r,sql:e}),i}finally{s&&await Fr(s)}}var j=d("getEncryptedChromeCookie");function Dr(r){if(typeof r!="string")return!1;let e=r.trim();return e.length===0?!1:(0,ye.existsSync)(e)}async function Ar(){let r=[(0,q.join)(O,"Default/Cookies"),(0,q.join)(O,"Profile */Cookies"),(0,q.join)(O,"Profile Default/Cookies")],e=[];for(let t of r){let o=await(0,Ce.default)(t);e.push(...o)}return j.debug("ChromeCookies","Found cookie files",{count:e.length,files:e}),e}function jr(r,e){let t=r==="%",o=t?"SELECT name, encrypted_value, host_key, expires_utc FROM cookies WHERE host_key LIKE ?":"SELECT name, encrypted_value, host_key, expires_utc FROM cookies WHERE name = ? AND host_key LIKE ?",a=t?[`%${e}%`]:[r,`%${e}%`];return{sql:o,params:a}}async function zr(r,e,t){try{let{sql:o,params:a}=jr(e,t);j.debug("ChromeCookies","Executing query",{sql:o,params:a});let s=await Q({file:r,sql:o,params:a,rowTransform:i=>({name:i.name,domain:i.host_key,value:i.encrypted_value,expiry:i.expires_utc})});return ce("QueryCookies",!0,{file:r,count:s.length}),s}catch(o){return c("Failed to read cookie file",o,{file:r}),[]}}async function be({name:r,domain:e,file:t}){let o=typeof t=="string"&&t.length>0?[t]:await Ar();if(o.length===0)return j.debug("ChromeCookies","No cookie files found"),[];let a=[];for(let s of o){if(!Dr(s)){j.debug("ChromeCookies","Cookie file missing or invalid",{file:s});continue}let i=await zr(s,r,e);a.push(...i)}return j.debug("ChromeCookies","Query complete",{totalCookies:a.length}),a}var ke=E(require("fast-glob"),1);var Nr=d("listChromeProfiles");function we(){let r=ke.default.sync("./**/Cookies",{cwd:O,absolute:!0});return Nr.debug("Found cookie files:",r),r}var V=require("crypto");var Ur=typeof global=="object"&&global&&global.Object===Object&&global,Se=Ur;var Qr=typeof self=="object"&&self&&self.Object===Object&&self,qr=Se||Qr||Function("return this")(),R=qr;var $r=R.Symbol,_=$r;var ve=Object.prototype,Mr=ve.hasOwnProperty,Wr=ve.toString,z=_?_.toStringTag:void 0;function Hr(r){var e=Mr.call(r,z),t=r[z];try{r[z]=void 0;var o=!0}catch{}var a=Wr.call(r);return o&&(e?r[z]=t:delete r[z]),a}var Ee=Hr;var Vr=Object.prototype,Gr=Vr.toString;function Jr(r){return Gr.call(r)}var Oe=Jr;var Kr="[object Null]",Zr="[object Undefined]",Re=_?_.toStringTag:void 0;function Xr(r){return r==null?r===void 0?Zr:Kr:Re&&Re in Object(r)?Ee(r):Oe(r)}var _e=Xr;function Yr(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}var $=Yr;var et="[object AsyncFunction]",rt="[object Function]",tt="[object GeneratorFunction]",ot="[object Proxy]";function at(r){if(!$(r))return!1;var e=_e(r);return e==rt||e==tt||e==et||e==ot}var Be=at;var st=R["__core-js_shared__"],M=st;var Pe=function(){var r=/[^.]+$/.exec(M&&M.keys&&M.keys.IE_PROTO||"");return r?"Symbol(src)_1."+r:""}();function it(r){return!!Pe&&Pe in r}var Ie=it;var nt=Function.prototype,ft=nt.toString;function pt(r){if(r!=null){try{return ft.call(r)}catch{}try{return r+""}catch{}}return""}var Le=pt;var lt=/[\\^$.*+?()[\]{}|]/g,ut=/^\[object .+?Constructor\]$/,mt=Function.prototype,dt=Object.prototype,ct=mt.toString,gt=dt.hasOwnProperty,xt=RegExp("^"+ct.call(gt).replace(lt,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function ht(r){if(!$(r)||Ie(r))return!1;var e=Be(r)?xt:ut;return e.test(Le(r))}var Te=ht;function yt(r,e){return r?.[e]}var Fe=yt;function Ct(r,e){var t=Fe(r,e);return Te(t)?t:void 0}var W=Ct;function bt(r,e){return r===e||r!==r&&e!==e}var De=bt;var kt=W(Object,"create"),C=kt;function wt(){this.__data__=C?C(null):{},this.size=0}var Ae=wt;function St(r){var e=this.has(r)&&delete this.__data__[r];return this.size-=e?1:0,e}var je=St;var vt="__lodash_hash_undefined__",Et=Object.prototype,Ot=Et.hasOwnProperty;function Rt(r){var e=this.__data__;if(C){var t=e[r];return t===vt?void 0:t}return Ot.call(e,r)?e[r]:void 0}var ze=Rt;var _t=Object.prototype,Bt=_t.hasOwnProperty;function Pt(r){var e=this.__data__;return C?e[r]!==void 0:Bt.call(e,r)}var Ne=Pt;var It="__lodash_hash_undefined__";function Lt(r,e){var t=this.__data__;return this.size+=this.has(r)?0:1,t[r]=C&&e===void 0?It:e,this}var Ue=Lt;function B(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var o=r[e];this.set(o[0],o[1])}}B.prototype.clear=Ae;B.prototype.delete=je;B.prototype.get=ze;B.prototype.has=Ne;B.prototype.set=Ue;var te=B;function Tt(){this.__data__=[],this.size=0}var Qe=Tt;function Ft(r,e){for(var t=r.length;t--;)if(De(r[t][0],e))return t;return-1}var k=Ft;var Dt=Array.prototype,At=Dt.splice;function jt(r){var e=this.__data__,t=k(e,r);if(t<0)return!1;var o=e.length-1;return t==o?e.pop():At.call(e,t,1),--this.size,!0}var qe=jt;function zt(r){var e=this.__data__,t=k(e,r);return t<0?void 0:e[t][1]}var $e=zt;function Nt(r){return k(this.__data__,r)>-1}var Me=Nt;function Ut(r,e){var t=this.__data__,o=k(t,r);return o<0?(++this.size,t.push([r,e])):t[o][1]=e,this}var We=Ut;function P(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var o=r[e];this.set(o[0],o[1])}}P.prototype.clear=Qe;P.prototype.delete=qe;P.prototype.get=$e;P.prototype.has=Me;P.prototype.set=We;var He=P;var Qt=W(R,"Map"),Ve=Qt;function qt(){this.size=0,this.__data__={hash:new te,map:new(Ve||He),string:new te}}var Ge=qt;function $t(r){var e=typeof r;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?r!=="__proto__":r===null}var Je=$t;function Mt(r,e){var t=r.__data__;return Je(e)?t[typeof e=="string"?"string":"hash"]:t.map}var w=Mt;function Wt(r){var e=w(this,r).delete(r);return this.size-=e?1:0,e}var Ke=Wt;function Ht(r){return w(this,r).get(r)}var Ze=Ht;function Vt(r){return w(this,r).has(r)}var Xe=Vt;function Gt(r,e){var t=w(this,r),o=t.size;return t.set(r,e),this.size+=t.size==o?0:1,this}var Ye=Gt;function I(r){var e=-1,t=r==null?0:r.length;for(this.clear();++e<t;){var o=r[e];this.set(o[0],o[1])}}I.prototype.clear=Ge;I.prototype.delete=Ke;I.prototype.get=Ze;I.prototype.has=Xe;I.prototype.set=Ye;var oe=I;var Jt="Expected a function";function ae(r,e){if(typeof r!="function"||e!=null&&typeof e!="function")throw new TypeError(Jt);var t=function(){var o=arguments,a=e?e.apply(this,o):o[0],s=t.cache;if(s.has(a))return s.get(a);var i=r.apply(this,o);return t.cache=s.set(a,i)||s,i};return t.cache=new(ae.Cache||oe),t}ae.Cache=oe;var H=ae;var Kt=H(r=>r.length>=3&&r[0]===118&&r[1]===49&&r[2]===48?r.slice(3):r,r=>r.toString("hex")),Zt=H(r=>{let e=r[r.length-1];return e&&e<=16?r.slice(0,-e):r},r=>r.toString("hex"));function Xt(r){let e=[/.*?0t(.+)$/,/.*?1e`(.+)$/,/.*?[`'](.+)$/,/[^\x20-\x7E]*([\x20-\x7E].+)$/];for(let t of e){let a=r.match(t)?.[1]??"";if(a.length>0)return a}return r}async function er(r,e){if(typeof e!="string")throw new Error("password must be a string");if(!Buffer.isBuffer(r))throw new Error("encryptedData must be a Buffer");return new Promise((t,o)=>{(0,V.pbkdf2)(e,"saltysalt",1003,16,"sha1",(a,s)=>{try{if(a){o(new Error("Failed to derive key: "+a.message));return}let i=Kt(r);if(i.length%16!==0){o(new Error("Encrypted data length is not a multiple of 16"));return}let p=Buffer.alloc(16," "),f=(0,V.createDecipheriv)("aes-128-cbc",s,p);f.setAutoPadding(!1);let u=f.update(i);try{f.final()}catch(g){o(new Error("Failed to finalize decryption: "+g.message));return}u=Zt(u);let m=u.toString("utf8");t(Xt(m))}catch(i){o(new Error("Decryption failed: "+i.message))}})})}var ie=require("os");var rr=require("child_process"),tr=require("util");var Yt=(0,tr.promisify)(rr.exec),se=class extends Error{constructor(t,o,a){super(t);this.command=o;this.originalError=a;this.name="CommandExecutionError"}};async function or(r,e){try{let t=await Yt(r,{...e,encoding:"utf8"});return{stdout:t.stdout.toString(),stderr:t.stderr.toString()}}catch(t){throw c("Command execution failed",t,{command:r}),new se(t instanceof Error?t.message:String(t),r,t instanceof Error?t:void 0)}}async function ar(){return(await or('security find-generic-password -w -s "Chrome Safe Storage"')).stdout.trim()}async function sr(){switch((0,ie.platform)()){case"darwin":return ar();default:throw new Error(`Platform ${(0,ie.platform)()} is not supported`)}}function eo(r){return typeof r!="number"||r<=0?"Infinity":new Date(r)}function ir(r,e,t,o,a,s){return{domain:r,name:e,value:t,expiry:eo(o),meta:{file:a,browser:"Chrome",decrypted:s}}}var L=class{constructor(){this.logger=d("ChromeCookieQueryStrategy");this.browserName="Chrome"}async queryCookies(e,t,o){try{if(this.logger.info("Querying cookies",{name:e,domain:t,store:o}),process.platform!=="darwin")return this.logger.warn("Platform not supported",{platform:process.platform}),[];let a=o??we(),s=Array.isArray(a)?a:[a];if(s.length===0)return this.logger.warn("No Chrome cookie files found"),[];let i=await sr();return(await Promise.all(s.map(f=>this.processFile(f,e,t,i)))).flat()}catch(a){return a instanceof Error?c("Failed to query cookies",a,{name:e,domain:t}):c("Failed to query cookies",new Error(String(a)),{name:e,domain:t}),[]}}async processFile(e,t,o,a){try{let s=await be({name:t,domain:o,file:e}),i={file:e,password:a};return(await Promise.allSettled(s.map(f=>this.processCookie(f,i)))).map(f=>f.status==="fulfilled"?f.value:null).filter(f=>f!==null)}catch(s){return s instanceof Error?this.logger.error("Failed to process cookie file",{error:s,file:e}):this.logger.error("Failed to process cookie file",{error:String(s),file:e}),[]}}async processCookie(e,t){try{let o=Buffer.isBuffer(e.value)?e.value:Buffer.from(String(e.value)),a=await er(o,t.password);return ir(e.domain,e.name,a,e.expiry,t.file,!0)}catch(o){return o instanceof Error?this.logger.warn("Failed to decrypt cookie",{error:o}):this.logger.warn("Failed to decrypt cookie",{error:String(o)}),ir(e.domain,e.name,e.value.toString("utf-8"),e.expiry,t.file,!1)}}};async function nr(r,e,t=[]){return r.length===0?t:(await Promise.all(r.map(async a=>{try{return await e(a)}catch{return t}}))).flat()}var N=class{constructor(e){this.strategies=e;this.logger=d("CompositeCookieQueryStrategy");this.browserName="internal"}handleStrategyError(e,t){e instanceof Error?this.logger.error("Strategy failed",{error:e,strategy:t}):this.logger.error("Strategy failed with unknown error",{error:String(e),strategy:t})}async queryCookies(e,t,o){try{return this.logger.info("Querying cookies from all strategies",{name:e,domain:t,store:o,strategyCount:this.strategies.length}),await nr(this.strategies,async a=>{try{return await a.queryCookies(e,t,o)}catch(s){return this.handleStrategyError(s,a),[]}},[])}catch(a){return a instanceof Error?this.logger.error("Failed to query cookies",{error:a}):this.logger.error("Failed to query cookies with unknown error",{error:String(a)}),[]}}};var fr=require("os"),ne=require("path"),pr=E(require("fast-glob"),1);var ro=d("FirefoxCookieQueryStrategy");function to(){let r=(0,fr.homedir)();if(!r)return x("FirefoxCookieQuery","Failed to get home directory"),[];let e=[(0,ne.join)(r,"Library/Application Support/Firefox/Profiles/*/cookies.sqlite"),(0,ne.join)(r,".mozilla/firefox/*/cookies.sqlite")],t=[];for(let o of e){let a=pr.default.sync(o);t.push(...a)}return ro.debug("Found Firefox cookie files",{files:t}),t}var T=class{constructor(){this.browserName="Firefox"}async queryCookies(e,t,o){let a=o??to(),s=Array.isArray(a)?a:[a],i=[];for(let p of s)try{let f=await Q({file:p,sql:"SELECT name, value, host as domain, expiry FROM moz_cookies WHERE name = ? AND host LIKE ?",params:[e,`%${t}%`],rowTransform:u=>({name:u.name,value:u.value,domain:u.domain,expiry:u.expiry>0?new Date(u.expiry*1e3):"Infinity",meta:{file:p,browser:"Firefox",decrypted:!1}})});i.push(...f)}catch(f){f instanceof Error?x("FirefoxCookieQuery",`Error reading Firefox cookie file ${p}`,{error:f.message}):x("FirefoxCookieQuery",`Error reading Firefox cookie file ${p}`)}return i}};var Cr=require("os"),br=require("path");var cr=require("buffer"),gr=require("fs"),xr=require("os"),hr=require("path");var K=require("buffer");var lr=E(require("destr"),1),n=require("zod"),G=n.z.string().trim().min(1,"Domain cannot be empty").refine(r=>/^\.?[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(r),"Invalid domain format"),J=n.z.string().trim().min(1,"Cookie name cannot be empty").refine(r=>r==="%"||/^[!#$%&'()*+\-.:0-9A-Z \^_`a-z|~]+$/.test(r),"Invalid cookie name format - must contain only valid characters (letters, numbers, and certain symbols) or be '%' for wildcard"),ur=n.z.string().trim().min(1,"Path cannot be empty").refine(r=>r.startsWith("/"),"Path must start with /").refine(r=>/^\/[!#$%&'()*+,\-./:=@\w~]*$/.test(r),"Invalid path format - must contain only valid URL path characters").default("/"),mr=n.z.string().trim().transform(r=>(0,lr.default)(r)).pipe(n.z.any()),dr=n.z.object({name:J,value:mr,domain:G,path:ur,expiry:n.z.number().int(),creation:n.z.number().int(),flags:n.z.number().optional(),version:n.z.number().int().optional(),port:n.z.number().int().optional(),comment:n.z.string().optional(),commentURL:n.z.string().optional()}),Ws=n.z.object({name:J,domain:G}).strict(),oo=n.z.object({file:n.z.string().trim().min(1,"File path cannot be empty").optional(),browser:n.z.string().trim().optional(),decrypted:n.z.boolean().optional(),secure:n.z.boolean().optional(),httpOnly:n.z.boolean().optional(),path:ur.optional()}).catchall(n.z.unknown()).strict(),ao=n.z.object({domain:G,name:J,value:mr,expiry:n.z.union([n.z.literal("Infinity"),n.z.date(),n.z.number().int().positive("Expiry must be a positive number")]).optional(),meta:oo.optional()}).strict(),Hs=n.z.object({expiry:n.z.number().int().optional(),domain:G,name:J,value:n.z.union([n.z.string(),n.z.instanceof(Buffer)])}).strict(),Vs=n.z.object({format:n.z.enum(["merged","grouped"]).optional(),separator:n.z.string().optional(),showFilePaths:n.z.boolean().optional()}).strict(),so=n.z.enum(["Chrome","Firefox","Safari","internal","unknown"]),Gs=n.z.object({browserName:so,queryCookies:n.z.function().args(n.z.string(),n.z.string(),n.z.string().optional()).returns(n.z.promise(n.z.array(ao)))}).strict();var S=d("BinaryCodableCookie"),Z=class{constructor(e){this.version=0;this.url="";this.name="";this.path="";this.value="";this.flags={isSecure:!1,isHTTPOnly:!1,unknown1:!1,unknown2:!1};this.expiration=0;this.creation=0;let t={offset:0,buffer:e};this.decode(t)}decodeUrlValue(e){let t=e,o;do{o=t;try{t=decodeURIComponent(t)}catch{return o}}while(t!==o&&t.includes("%"));return t}decodeJwtPayload(e){let t=e.split(".");if(t.length!==3)return null;try{let o=K.Buffer.from(t[1],"base64").toString("utf8"),a=JSON.parse(o);return JSON.stringify(a)}catch{return null}}parseJsonValue(e){try{let t=JSON.parse(e);return JSON.stringify(t)}catch{return null}}processValue(e){let t=this.decodeUrlValue(e);if(t.match(/^ey[A-Za-z0-9_-]+\.ey[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$/)){let o=this.decodeJwtPayload(t);if(typeof o=="string"&&o.length>0)return o}if(t.startsWith("{")||t.startsWith("[")){let o=this.parseJsonValue(t);if(typeof o=="string"&&o.length>0)return o}return t}toCookieRow(){try{let e=this.convertFlags(),t=this.url.replace(/^https?:\/\//,"").replace(/\/.*$/,"")||"uk",o=978307200,a=this.expiration>0?this.expiration+o:this.expiration,s=this.creation>0?this.creation+o:this.creation;return dr.parse({name:this.name.replace(/^: /,""),value:this.processValue(this.value)||"",domain:t,path:this.path||"/",expiry:a,creation:s,flags:e,version:this.version,port:this.port,comment:this.comment,commentURL:this.commentURL})}catch{return null}}readNullTerminatedString(e,t){let o=t;for(;o<e.buffer.length&&e.buffer[o]!==0;)o++;return e.buffer.toString("utf8",t,o)||""}readHeader(e){let t=e.buffer.readUInt32LE(e.offset);S.debug("Cookie size:",t),e.offset+=4;let o=e.buffer.readUInt32LE(e.offset);S.debug("Cookie version:",o),e.offset+=4;let a=e.buffer.readUInt32LE(e.offset);S.debug("Cookie flags:",a.toString(2).padStart(8,"0")),e.offset+=4,this.flags={isSecure:(a&1)!==0,isHTTPOnly:(a&4)!==0,unknown1:(a&8)!==0,unknown2:(a&16)!==0};let s=e.buffer.readUInt32LE(e.offset);S.debug("Has port:",s),e.offset+=4;let i={urlOffset:e.buffer.readUInt32LE(e.offset),nameOffset:e.buffer.readUInt32LE(e.offset+4),pathOffset:e.buffer.readUInt32LE(e.offset+8),valueOffset:e.buffer.readUInt32LE(e.offset+12),commentOffset:e.buffer.readUInt32LE(e.offset+16),commentURLOffset:e.buffer.readUInt32LE(e.offset+20)};return S.debug("String offsets:",i),{size:t,hasPort:s,offsets:i}}readTimestamps(e){let t=K.Buffer.alloc(8);for(let i=0;i<8;i++)t[i]=e.buffer[e.offset+i];let o=t.readDoubleLE(0);e.offset+=8;let a=K.Buffer.alloc(8);for(let i=0;i<8;i++)a[i]=e.buffer[e.offset+i];let s=a.readDoubleLE(0);e.offset+=8,this.expiration=o,this.creation=s}readStrings(e,t,o){S.debug("Reading strings from cookie buffer of size:",t);let s=[{field:"url",offset:o.urlOffset},{field:"name",offset:o.nameOffset},{field:"path",offset:o.pathOffset},{field:"value",offset:o.valueOffset},{field:"comment",offset:o.commentOffset}].filter(i=>i.offset>0).sort((i,p)=>i.offset-p.offset);S.debug("Reading strings in order:",s.map(i=>i.field));for(let i=0;i<s.length;i++){let{field:p,offset:f}=s[i],m=(i<s.length-1?s[i+1].offset:t)-f,g=0+f;for(;g<0+f+m&&e.buffer[g]!==0;)g++;let b=e.buffer.toString("utf8",0+f,g);switch(S.debug(`Read ${p}:`,b),p){case"url":this.url=b;break;case"name":this.name=b;break;case"path":this.path=b;break;case"value":this.value=b;break;case"comment":this.comment=b;break}}}decode(e){let{size:t,hasPort:o,offsets:a}=this.readHeader(e),s=e.offset;e.offset=s+24,this.readTimestamps(e),o>0&&(this.port=e.buffer.readUInt16LE(e.offset),e.offset+=2),e.offset=s,this.readStrings(e,t,a)}convertFlags(){return(this.flags.isSecure?1:0)|(this.flags.isHTTPOnly?4:0)|(this.flags.unknown1?8:0)|(this.flags.unknown2?16:0)}};var h=d("BinaryCodablePage"),F=class F{constructor(e){this.cookies=[];let t={offset:0,buffer:e};this.decode(t)}toCookieRows(){let e=[];for(let t of this.cookies)try{let o=t.toCookieRow();o!==null&&e.push(o)}catch(o){let a=o instanceof Error?o.message:String(o);x("BinaryCookies","Error converting cookie",{error:a})}return e}decode(e){let t=e.buffer.readUInt32BE(e.offset);if(h.debug("Page header:",t.toString(16)),e.offset+=4,t!==F.HEADER)throw new Error("Invalid page header");let o=e.buffer.readUInt32LE(e.offset);h.debug("Cookie count:",o),e.offset+=4;let a=e.offset-8;h.debug("Page start offset:",a);let s=[];for(let p=0;p<o;p++){let f=e.buffer.readUInt32LE(e.offset);s.push(f),h.debug(`Cookie ${p} offset:`,f),e.offset+=4}let i=e.buffer.readUInt32BE(e.offset);if(h.debug("Page footer:",i.toString(16)),e.offset+=4,i!==F.FOOTER)throw new Error("Invalid page footer");for(let p=0;p<o;p++)try{let f=s[p];h.debug(`Reading cookie ${p} at offset:`,f);let u=e.buffer.readUInt32LE(f);if(h.debug(`Cookie ${p} size:`,u),u<48){h.warn(`Invalid cookie size ${u} at index ${p}`);continue}if(f+u>e.buffer.length){h.warn(`Cookie size ${u} at index ${p} would exceed buffer length ${e.buffer.length}`);continue}let m=e.buffer.subarray(f,f+u),g=new Z(m);this.cookies.push(g)}catch(f){h.warn("Invalid cookie data",{error:f instanceof Error?f.message:String(f)})}}};F.HEADER=256,F.FOOTER=0;var X=F;var v=d("BinaryCodableCookies"),y=class y{constructor(e){let t={offset:0,buffer:e};this.pages=[],this.metadata={},this.decode(t)}static fromFile(e){let t=(0,gr.readFileSync)(e);return new y(t)}static fromDefaultPath(){return y.fromFile(y.DEFAULT_COOKIE_PATH)}toCookieRows(){let e=[];for(let t of this.pages)try{let o=t.toCookieRows();Array.isArray(o)&&e.push(...o)}catch(o){let a=o instanceof Error?o.message:String(o);x("BinaryCookies","Error converting page cookies",{error:a})}return e}decode(e){try{let t=e.buffer.subarray(e.offset,e.offset+4);if(e.offset+=4,v.debug("Magic bytes:",t.toString()),!t.equals(y.MAGIC))throw new Error("Missing magic value");let o=e.buffer.readUInt32BE(e.offset);v.debug("Page count:",o),e.offset+=4;let a=[];for(let u=0;u<o;u++){let m=e.buffer.readUInt32BE(e.offset);a.push(m),v.debug(`Page ${u} size:`,m),e.offset+=4}let s=e.offset;v.debug("Starting page data at offset:",s);for(let u of a)try{v.debug("Reading page at offset:",s,"with size:",u);let m=e.buffer.subarray(s,s+u),g=new X(m);this.pages.push(g),s+=u}catch(m){let g=m instanceof Error?m.message:String(m);v.warn("Error decoding page:",{error:g}),s+=u}e.offset=s;let i=e.buffer.readUInt32BE(e.offset);v.debug("Checksum:",i.toString(16)),e.offset+=4;let p=e.buffer.readBigUInt64BE(e.offset);v.debug("Footer:",p.toString(16)),e.offset+=8,p!==y.FOOTER&&x("BinaryCookies","Invalid cookie file format: wrong footer");let f=e.buffer.subarray(e.offset);this.metadata={}}catch(t){let o=t instanceof Error?t.message:String(t);throw x("BinaryCookies","Error decoding binary cookies file",{error:o}),t}}};y.MAGIC=cr.Buffer.from("cook","utf8"),y.FOOTER=BigInt("0x071720050000004b"),y.DEFAULT_COOKIE_PATH=(0,hr.join)((0,xr.homedir)(),"Library/Containers/com.apple.Safari/Data/Library/Cookies/Cookies.binarycookies");var Y=y;function yr(r){return Y.fromFile(r).toCookieRows()}var D=class{constructor(){this.browserName="Safari"}getCookieDbPath(e){return(0,br.join)(e,"Library","Containers","com.apple.Safari","Data","Library","Cookies","Cookies.binarycookies")}formatDomain(e){return e.startsWith(".")?e.slice(1):e}formatExpiry(e){return e<=0?"Infinity":new Date(e*1e3)}isFlagSet(e,t){return typeof e!="number"||isNaN(e)||e<=0?!1:(e&t)===t}formatCreation(e){if(!(typeof e!="number"||isNaN(e)||e<=0))return e*1e3}decodeCookies(e,t,o){try{return yr(e).filter(s=>(t==="%"||s.name===t)&&(o==="%"||this.formatDomain(s.domain).includes(o))).map(s=>({domain:this.formatDomain(s.domain),name:s.name,value:Buffer.isBuffer(s.value)?s.value.toString():String(s.value),expiry:this.formatExpiry(s.expiry),meta:{file:e,browser:"Safari",decrypted:!1,secure:this.isFlagSet(s.flags,1),httpOnly:this.isFlagSet(s.flags,4),path:s.path,version:s.version,comment:s.comment,commentURL:s.commentURL,port:s.port,creation:this.formatCreation(s.creation)}}))}catch(a){return a instanceof Error?c("SafariCookieQueryStrategy",`Error decoding ${e}`,{error:a,name:t,domain:o}):c("SafariCookieQueryStrategy",`Error decoding ${e}`,{error:"Unknown error",name:t,domain:o}),[]}}async queryCookies(e,t,o){let a=(0,Cr.homedir)();if(typeof a!="string"||a.length===0)return c("SafariCookieQueryStrategy","Failed to get home directory"),Promise.resolve([]);let s=o??this.getCookieDbPath(a);return Promise.resolve(this.decodeCookies(s,e||"%",t||"%"))}};var kr={strategies:new Map([["safari",D],["firefox",T],["chrome",L]]),createStrategy(r){if(typeof r!="string")return new N([new D,new T,new L]);let e=this.strategies.get(r.toLowerCase());return e!==void 0?new e:new N([new D,new T,new L])}};function io(r,e,t){if(!r||!(e in r))return null;let o=r[e];if(typeof o!==t)return null;let a=e.charAt(0).toUpperCase()+e.slice(1),s=t==="number"?o:String(o);return`  ${a}: ${s}`}function no(r){let e=[],t=r.meta?.creation;if(typeof t=="number"){let o=new Date(t*1e3);e.push(`  Creation: ${o.toISOString()}`)}if(r.expiry!=="Infinity"&&(typeof r.expiry=="number"||r.expiry instanceof Date)){let o=new Date(r.expiry);e.push(`  Expiry: ${o.toISOString()}`)}return e}function fo(r){let e=["Cookie details:",`  Name: ${r.name}`,`  Domain: ${r.domain}`,`  Value: ${r.value}`],t=["path","flags","version"];for(let o of t){let a=io(r.meta,o,o==="path"?"string":"number");a!==null&&e.push(a)}return e.push(...no(r)),e.push(""),e}async function po(r,e,t){let o=[];for(let a of e){let s=await r.queryCookies(a,t);if(o=[...o,...s],typeof t.limit=="number"&&t.limit>0&&o.length>=t.limit){o=o.slice(0,t.limit);break}}return o}async function wr(r,e,t,o=!1,a){try{let s=typeof r.browser=="string"?r.browser:void 0,i=kr.createStrategy(s),p=new U(i),f=Array.isArray(e)?e:[e],u=await po(p,f,{limit:t,removeExpired:o,store:a,strategy:i});if(u.length===0){l.error("No results");return}r["--json"]===!0?l.log(JSON.stringify(u,null,2)):u.forEach(m=>{fo(m).forEach(b=>l.log(b))})}catch(s){s instanceof Error?l.error(s.message):l.error("An unknown error occurred")}}function lo(){l.log("Usage: get-cookie [name] [domain] [options]"),l.log("Options:"),l.log("  -h, --help: Show this help message"),l.log("  -v, --verbose: Enable verbose output"),l.log("  -d, --dump: Dump all results"),l.log("  -D, --dump-grouped: Dump all results, grouped by profile"),l.log("  -r, --render: Render all results"),l.log("  -u, --url: URL to extract cookie specs from"),l.log("  -n, --name: Cookie name pattern"),l.log("  -d, --domain: Cookie domain pattern"),l.log("  --store: Path to a specific binarycookies store file"),l.log("  --output: Output format (e.g., json)")}function uo(r,e){return{name:r||"%",domain:e||"%"}}function mo(r,e){let t=r.url;if(typeof t=="string"){let s=ee(t);return Array.isArray(s)?s:(l.error("Invalid cookie specs from URL"),[])}let o=r.name||e[0]||"%",a=r.domain||e[1]||"%";return[uo(o,a)]}async function co(r,e){let t=mo(r,e);r.verbose===!0&&l.log("cookieSpecs",t);try{await wr(r,t,void 0,r.removeExpired===!0,r.store)}catch(o){o instanceof Error?l.error("Error querying cookies:",o.message):l.error("An unknown error occurred while querying cookies")}}async function go(){let r=process.argv.slice(2),{values:e,positionals:t}=le(r);if(e.help===!0){lo();return}await co(e,t)}go().catch(r=>{r instanceof Error?l.error("Fatal error:",r.message):l.error("An unknown fatal error occurred"),process.exit(1)});
/*! Bundled license information:

lodash-es/lodash.js:
  (**
   * @license
   * Lodash (Custom Build) <https://lodash.com/>
   * Build: `lodash modularize exports="es" -o ./`
   * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
   * Released under MIT license <https://lodash.com/license>
   * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
   * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
   *)
*/
//# sourceMappingURL=cli.cjs.map